<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ETH BTC å¤šæ—¶é—´æ®µ Spreadï¼ˆ5åˆ†é’ŸKçº¿ç‰ˆï¼‰</title>
  <style>
    body{
      font-family: Arial;
      background:#0b0f14;
      color:#00ffa3;
      text-align:center;
      padding:20px 10px;
      margin:0;
    }
    h1{font-size:1.8rem;margin:10px 0 20px;}
    .box{
      background:rgba(0,255,163,0.08);
      border-radius:12px;
      padding:16px;
      margin:16px auto;
      max-width:400px;
      font-size:1.5rem;
    }
    .label{color:#aaa;font-size:1rem;margin-bottom:6px;display:block;}
    .value{font-size:2rem;font-weight:bold;}
    .positive{color:#00ff9d;}
    .negative{color:#ff4d6a;}
    .small{font-size:0.9rem;color:#888;margin:20px 0;}
  </style>
</head>
<body>

<h1>ETH / BTC å¤šæ—¶é—´æ®µ Spread</h1>

<div id="data-container">
  <!-- æ•°æ®ä¼šåœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
</div>

<div class="small">
  æ•°æ®æ¥æºï¼šBinance 5åˆ†é’ŸKçº¿<br>
  æ¯ 5 åˆ†é’Ÿæ›´æ–°ä¸€æ¬¡ï¼ˆä¸Kçº¿åŒæ­¥ï¼‰
</div>

<script>
  const ALERT_THRESHOLD = 1.8;   // 24h spread è­¦æŠ¥é˜ˆå€¼
  let alertSent = false;

  const timeframes = [
    { key: '4h',  hours: 4,  label: '4å°æ—¶' },
    { key: '12h', hours: 12, label: '12å°æ—¶' },
    { key: '24h', hours: 24, label: '24å°æ—¶' }
  ];

  // æ‹‰å– 5 åˆ†é’Ÿ K çº¿ï¼ˆæœ€å¤š 500 æ ¹ â‰ˆ 41.67 å°æ—¶ï¼Œè¶³å¤Ÿè¦†ç›– 24h+ï¼‰
  async function fetchKlines(symbol) {
    const url = `https://api.binance.com/api/v3/klines?symbol=${symbol}&interval=5m&limit=500`;
    const res = await fetch(url);
    if (!res.ok) throw new Error('Binance API é”™è¯¯');
    return await res.json(); // [[openTime, open, high, low, close, ...], ...]
  }

  function calcChange(klines, hours) {
    if (klines.length < 2) return 0;
    const now = Date.now();
    const targetTime = now - hours * 3600000;

    const latestClose = parseFloat(klines[klines.length-1][4]); // å½“å‰æ”¶ç›˜ä»·

    // æ‰¾åˆ°ç¦»ç›®æ ‡æ—¶é—´æœ€è¿‘çš„Kçº¿ï¼ˆç”¨å¼€ç›˜æ—¶é—´ï¼‰
    let closest = klines[0];
    for (const k of klines) {
      if (Math.abs(k[0] - targetTime) < Math.abs(closest[0] - targetTime)) {
        closest = k;
      }
    }
    const pastOpen = parseFloat(closest[1]);
    if (pastOpen === 0) return 0;
    return ((latestClose - pastOpen) / pastOpen) * 100;
  }

  async function update() {
    try {
      const [btcKlines, ethKlines] = await Promise.all([
        fetchKlines('BTCUSDT'),
        fetchKlines('ETHUSDT')
      ]);

      let html = '';
      let spread24h = 0;

      timeframes.forEach(tf => {
        const btcChg = calcChange(btcKlines, tf.hours);
        const ethChg = calcChange(ethKlines, tf.hours);
        const spread = ethChg - btcChg;

        if (tf.key === '24h') spread24h = spread;

        const spreadClass = spread >= 0 ? 'positive' : 'negative';

        html += `
          <div class="box">
            <span class="label">${tf.label} Spread</span>
            <div>BTC <span class="value">${btcChg.toFixed(2)}%</span></div>
            <div>ETH <span class="value">${ethChg.toFixed(2)}%</span></div>
            <div>å·®å€¼ <span class="value ${spreadClass}">${spread.toFixed(2)}%</span></div>
          </div>`;
      });

      document.getElementById('data-container').innerHTML = html;

      // åªå¯¹ 24h åšè­¦æŠ¥
      checkAlert(spread24h);

    } catch (e) {
      console.error(e);
      document.getElementById('data-container').innerHTML = 
        '<div style="color:#ff4d6a;padding:20px;">åŠ è½½å¤±è´¥ï¼Œ5ç§’åé‡è¯•...</div>';
    }
  }

  function checkAlert(spread24h) {
    const abs = Math.abs(spread24h);
    if (abs >= ALERT_THRESHOLD && !alertSent) {
      fetch(`/api/sendAlert?text=ğŸš¨ ETH-BTC 24h Spread çªç ´ ${ALERT_THRESHOLD}%ï¼å½“å‰ ${spread24h.toFixed(2)}%`)
        .then(() => alertSent = true);
    }
    if (abs < ALERT_THRESHOLD && alertSent) {
      alertSent = false;
    }
  }

  // å¯åŠ¨ï¼šç«‹å³æ‰§è¡Œä¸€æ¬¡ï¼Œç„¶åæ¯ 5 åˆ†é’Ÿï¼ˆ300000msï¼‰æ›´æ–°ä¸€æ¬¡
  update();
  setInterval(update, 5 * 60 * 1000);

</script>

</body>
</html>
